# AI ì±„íŒ… ìƒë‹´ ì‹œìŠ¤í…œ

> Gemini ê¸°ë°˜ ì¬ë¬´ ìƒë‹´ AI: 3-Step ì¿¼ë¦¬ ë¶„ì„ + Rolling Summary ëŒ€í™” ë§¥ë½ ê´€ë¦¬

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

MoneyTalkì˜ ì±„íŒ… ì‹œìŠ¤í…œì€ ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ì§€ì¶œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³ ,
ë°ì´í„° ê¸°ë°˜ì˜ ë§ì¶¤ ì¬ë¬´ ìƒë‹´ì„ ì œê³µí•©ë‹ˆë‹¤.

```
ì‚¬ìš©ì ì§ˆë¬¸: "ì´ë²ˆ ë‹¬ ì‹ë¹„ ì–¼ë§ˆì•¼?"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ì¿¼ë¦¬ ë¶„ì„ (queryAnalyzerModel)      â”‚
â”‚  â”” "ì‹ë¹„ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²ˆ ë‹¬ í•©ê³„ê°€ í•„ìš”í•˜êµ°"    â”‚
â”‚  â”” JSON: {type: "expense_by_category",     â”‚
â”‚           category: "ì‹ë¹„", ...}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: ë°ì´í„° ì¡°íšŒ/ì•¡ì…˜ ì‹¤í–‰ (Room DB)      â”‚
â”‚  â”” ExpenseDao.getExpenseSumByCategory()    â”‚
â”‚  â”” ë˜ëŠ” executeAnalytics() (í´ë¼ì´ì–¸íŠ¸ ì§‘ê³„) â”‚
â”‚  â”” ê²°ê³¼: ì‹ë¹„ 350,000ì›                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ë‹µë³€ ìƒì„± (financialAdvisorModel)   â”‚
â”‚  â”” [Rolling Summary + ìµœê·¼ ëŒ€í™” + ë°ì´í„°]    â”‚
â”‚  â”” "ì´ë²ˆ ë‹¬ ì‹ë¹„ëŠ” 35ë§Œì›ì´ì•¼! ìˆ˜ì… ëŒ€ë¹„      â”‚
â”‚     15%ë¡œ ì ì • ìˆ˜ì¤€ì´ë„¤ ğŸ‘"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. 3-Step ì²˜ë¦¬ ì•„í‚¤í…ì²˜

### Step 1: ì¿¼ë¦¬/ì•¡ì…˜ ë¶„ì„

**íŒŒì¼**: `feature/chat/data/GeminiRepository.kt` â€” `analyzeQueryNeeds()`
**ëª¨ë¸**: `gemini-2.5-pro` (temperature: 0.3)
**í”„ë¡¬í”„íŠ¸**: `res/values/string_prompt.xml` â€” `prompt_query_analyzer_system`

ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ í•„ìš”í•œ DB ì¿¼ë¦¬ì™€ ì•¡ì…˜ì„ JSONìœ¼ë¡œ ê²°ì •í•©ë‹ˆë‹¤.
ì§ˆë¬¸ì´ ëª¨í˜¸í•œ ê²½ìš° ì¿¼ë¦¬ ëŒ€ì‹  `clarification` ì‘ë‹µì„ ë°˜í™˜í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì¶”ê°€ ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

#### Clarification ì‘ë‹µ (ëª¨í˜¸í•œ ì§ˆë¬¸ ì²˜ë¦¬)

ì§ˆë¬¸ì´ ëª¨í˜¸í•˜ì—¬ ì •í™•í•œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ì„ ë•Œ ë°˜í™˜:
- ê¸°ê°„ ë¶ˆëª…í™•: "ì–¼ë§ˆ ì¼ì–´?" (ì–´ëŠ ê¸°ê°„?)
- ëŒ€ìƒ ë¶ˆëª…í™•: "ì¤„ì—¬ì•¼ í• ê¹Œ?" (ë¬´ì—‡ì„?)
- ë‹¤ì¤‘ í•´ì„: "ì¹´ë“œ ì •ë¦¬í•´ì¤˜" (ì¡°íšŒ? ì‚­ì œ? ë³€ê²½?)

```json
{"clarification": "ì–´ë–¤ ì¹´í…Œê³ ë¦¬ì˜ ì ˆì•½ì„ ì•Œì•„ë³¼ê¹Œìš”? ì˜ˆ: ì¹´í˜, ë°°ë‹¬, ì‡¼í•‘ ë“±"}
```

ëŒ€í™” ë§¥ë½ìœ¼ë¡œ ì˜ë„ê°€ íŒŒì•… ê°€ëŠ¥í•˜ë©´ clarification ì—†ì´ ë°”ë¡œ ì¿¼ë¦¬ ìƒì„±.

#### ì¿¼ë¦¬ íƒ€ì… (17ì¢…)

| íƒ€ì… | ì„¤ëª… | í•„ìˆ˜ íŒŒë¼ë¯¸í„° |
|------|------|-------------|
| `total_expense` | ê¸°ê°„ ë‚´ ì´ ì§€ì¶œ | startDate, endDate |
| `total_income` | ê¸°ê°„ ë‚´ ì´ ìˆ˜ì… | startDate, endDate |
| `expense_by_category` | ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í•©ê³„ | startDate, endDate |
| `expense_list` | ì§€ì¶œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ | limit |
| `expense_by_store` | íŠ¹ì • ê°€ê²Œ ì§€ì¶œ | storeName |
| `expense_by_card` | íŠ¹ì • ì¹´ë“œ ì§€ì¶œ | cardName |
| `daily_totals` | ì¼ë³„ ì§€ì¶œ í•©ê³„ | startDate, endDate |
| `monthly_totals` | ì›”ë³„ ì§€ì¶œ í•©ê³„ | â€” |
| `monthly_income` | ì„¤ì •ëœ ì›” ìˆ˜ì… | â€” |
| `uncategorized_list` | ë¯¸ë¶„ë¥˜ í•­ëª© | â€” |
| `category_ratio` | ìˆ˜ì… ëŒ€ë¹„ ë¹„ìœ¨ ë¶„ì„ | â€” |
| `search_expense` | ê²€ìƒ‰ (ê°€ê²Œ/ì¹´í…Œê³ ë¦¬/ì¹´ë“œ) | searchKeyword |
| `card_list` | ì‚¬ìš© ì¹´ë“œ ëª©ë¡ | â€” |
| `income_list` | ìˆ˜ì… ë‚´ì—­ | startDate, endDate |
| `duplicate_list` | ì¤‘ë³µ ì§€ì¶œ í•­ëª© | â€” |
| `sms_exclusion_list` | SMS ì œì™¸ í‚¤ì›Œë“œ ëª©ë¡ | â€” |
| `analytics` | ë³µí•© ë¶„ì„ (í•„í„°+ê·¸ë£¹í•‘+ì§‘ê³„) | filters, groupBy, metrics |

#### ì•¡ì…˜ íƒ€ì… (12ì¢…)

| íƒ€ì… | ì„¤ëª… | í•„ìˆ˜ íŒŒë¼ë¯¸í„° |
|------|------|-------------|
| `update_category` | íŠ¹ì • ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ë³€ê²½ | expenseId, newCategory |
| `update_category_by_store` | ê°€ê²Œëª… ê¸°ì¤€ ì¼ê´„ ë³€ê²½ | storeName, newCategory |
| `update_category_by_keyword` | í‚¤ì›Œë“œ í¬í•¨ ì¼ê´„ ë³€ê²½ | searchKeyword, newCategory |
| `delete_expense` | íŠ¹ì • ì§€ì¶œ ì‚­ì œ | expenseId |
| `delete_by_keyword` | í‚¤ì›Œë“œ ê¸°ì¤€ ì¼ê´„ ì‚­ì œ | searchKeyword |
| `delete_duplicates` | ì¤‘ë³µ í•­ëª© ì „ì²´ ì‚­ì œ | â€” |
| `add_expense` | ìˆ˜ë™ ì§€ì¶œ ì¶”ê°€ | storeName, amount |
| `update_memo` | ë©”ëª¨ ìˆ˜ì • | expenseId, memo |
| `update_store_name` | ê°€ê²Œëª… ìˆ˜ì • | expenseId, newStoreName |
| `update_amount` | ê¸ˆì•¡ ìˆ˜ì • | expenseId, newAmount |
| `add_sms_exclusion` | SMS ì œì™¸ í‚¤ì›Œë“œ ì¶”ê°€ | searchKeyword |
| `remove_sms_exclusion` | SMS ì œì™¸ í‚¤ì›Œë“œ ì‚­ì œ | searchKeyword |

#### ANALYTICS ì¿¼ë¦¬ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì‹¤í–‰)

ChatViewModelì—ì„œ ì¸ë©”ëª¨ë¦¬ë¡œ ì‹¤í–‰ë˜ëŠ” ë³µí•© ë¶„ì„ ê¸°ëŠ¥:

| êµ¬ì„± ìš”ì†Œ | ì§€ì› ê°’ |
|----------|---------|
| **í•„í„° ì—°ì‚°ì** | ==, !=, >, >=, <, <=, contains, not_contains, in, not_in |
| **í•„í„° í•„ë“œ** | category, storeName, cardName, amount, memo, dayOfWeek |
| **ê·¸ë£¹í•‘** | category, storeName, cardName, date, month, dayOfWeek |
| **ì§‘ê³„ ë©”íŠ¸ë¦­** | sum, avg, count, max, min |
| **ì •ë ¬** | asc, desc |
| **topN** | ìƒìœ„ Nê°œ ê²°ê³¼ |
| **includeSubcategories** | í•˜ìœ„ ì¹´í…Œê³ ë¦¬ í¬í•¨ ì—¬ë¶€ |

#### ë‚ ì§œ í•´ì„ ê·œì¹™
- "ì´ë²ˆë‹¬" â†’ ì´ë²ˆë‹¬ 1ì¼ ~ ì˜¤ëŠ˜
- "ì§€ë‚œë‹¬" â†’ ì „ì›” 1ì¼ ~ ë§ì¼
- "3ê°œì›”ê°„" â†’ ìµœê·¼ 3ê°œì›”
- ì—°ë„ ë¯¸ì§€ì • â†’ ì˜¬í•´ë¡œ ê°€ì •

### Step 2: ë°ì´í„° ì¡°íšŒ / ì•¡ì…˜ ì‹¤í–‰

**íŒŒì¼**: `feature/chat/ui/ChatViewModel.kt`

- `executeQuery()`: DB ì¿¼ë¦¬ ì‹¤í–‰ (Room DAO í˜¸ì¶œ)
- `executeAction()`: DB ìˆ˜ì • ì•¡ì…˜ ì‹¤í–‰
- `executeAnalytics()`: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë³µí•© ë¶„ì„ (í•„í„° â†’ ê·¸ë£¹í•‘ â†’ ì§‘ê³„)

ì¿¼ë¦¬ ë¶„ì„ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ í´ë°±:
- `TOTAL_EXPENSE` + `EXPENSE_BY_CATEGORY` + `EXPENSE_LIST` (ìµœê·¼ 10ê±´)

### Step 3: ë‹µë³€ ìƒì„±

**ëª¨ë¸**: `gemini-2.5-pro` (temperature: 0.7)
**í”„ë¡¬í”„íŠ¸**: `res/values/string_prompt.xml` â€” `prompt_financial_advisor_system`

System Instructionì— ì¬ë¬´ ìƒë‹´ì‚¬ ì—­í• ì´ ì •ì˜ë˜ì–´ ìˆìœ¼ë©°, ë‹¤ìŒ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤:

- ì›” ìˆ˜ì… ì •ë³´
- Step 2ì—ì„œ ì¡°íšŒí•œ ë°ì´í„° / ANALYTICS ê³„ì‚° ê²°ê³¼
- ì•¡ì…˜ ì‹¤í–‰ ê²°ê³¼
- Rolling Summary (ê³¼ê±° ëŒ€í™” ë§¥ë½)
- ìµœê·¼ ëŒ€í™” ë©”ì‹œì§€

#### ë‹µë³€ ê·œì¹™ (í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€)
- ì¡°íšŒëœ ë°ì´í„°ì™€ ANALYTICS ê³„ì‚° ê²°ê³¼ë§Œ ì‚¬ìš© (ì§ì ‘ ê³„ì‚° ê¸ˆì§€)
- ì‹¤í–‰í•œ ì•¡ì…˜ì— ëŒ€í•´ì„œë§Œ ê²°ê³¼ ë³´ê³  (ì‹¤í–‰ ì•ˆ í•œ ì•¡ì…˜ ì–¸ê¸‰ ê¸ˆì§€)
- ì‚­ì œ/ìˆ˜ì • ì‘ì—…ì˜ ë˜ëŒë¦¬ê¸°ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤ëŠ” ì•ˆë‚´

#### ìˆ˜ì¹˜ ì •í™•ì„± ê·œì¹™ (Karpathy Guidelines ì ìš©)
- **ì§ì ‘ ê³„ì‚° ê¸ˆì§€**: ë¦¬ìŠ¤íŠ¸ í•­ëª© í•©ì‚°/í‰ê·  ê¸ˆì§€ â†’ ANALYTICS ê²°ê³¼ê°’ë§Œ ì¸ìš©
- **ë¹„ìœ¨ ê³„ì‚° ê¸ˆì§€**: ì§ì ‘ ë‚˜ëˆ—ì…ˆìœ¼ë¡œ % ì‚°ì¶œ ê¸ˆì§€ â†’ ë°ì´í„°ì— ë¹„ìœ¨ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¯¸ì œì‹œ
- **êµì°¨ ê³„ì‚° ê¸ˆì§€**: ì„œë¡œ ë‹¤ë¥¸ ì¿¼ë¦¬ ê²°ê³¼ë¼ë¦¬ í•©ì‚°/ë¹„êµí•˜ì—¬ ìƒˆ ìˆ˜ì¹˜ ìƒì„± ê¸ˆì§€
- **ë¶ˆí™•ì‹¤í•˜ë©´ ì¸ì •**: "ë°ì´í„°ì—ì„œ í™•ì¸ëœ ê°’ì€ ~ì…ë‹ˆë‹¤"ë¡œ ë²”ìœ„ í•œì •

#### ë‹µë³€ ìŠ¤íƒ€ì¼
- í•œêµ­ì–´ ë°˜ë§
- ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
- êµ¬ì²´ì  ìˆ«ìì™€ ì‹¤ìš©ì  ì¡°ì–¸
- ê°„ê²°í•˜ê³  ì‘ì›í•˜ëŠ” í†¤

#### ì§€ì¶œ ì ì • ê¸°ì¤€
| ì¹´í…Œê³ ë¦¬ | ìˆ˜ì… ëŒ€ë¹„ ì ì • ë¹„ìœ¨ |
|---------|-----------------|
| ì‹ë¹„ | 15-20% |
| ì£¼ê±°ë¹„ | 25-30% |
| êµí†µë¹„ | 5-10% |
| ì¹´í˜/ì—¬ê°€ | 5-10% |
| ì €ì¶• | 20% ì´ìƒ ê¶Œì¥ |
| ì´ ì§€ì¶œ | 80% ì´í•˜ë©´ ê±´ê°• |

---

## 3. Rolling Summary (ëŒ€í™” ë§¥ë½ ê´€ë¦¬)

### ë¬¸ì œ
AI ëª¨ë¸ì€ ì»¨í…ìŠ¤íŠ¸ ì œí•œì´ ìˆì–´ ê¸´ ëŒ€í™”ë¥¼ ëª¨ë‘ ì „ë‹¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ "ì•„ê¹Œ ë¬¼ì–´ë³¸ ì‹ë¹„ ë§ì¸ë°..." ê°™ì€ ë§¥ë½ ì°¸ì¡°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

### í•´ê²°: Rolling Summary + Windowed Context ì „ëµ

**í•µì‹¬ ì„¤ì •:**
- `WINDOW_SIZE_TURNS = 3` (ìµœê·¼ 3í„´ ìœ ì§€)
- `WINDOW_SIZE_MESSAGES = 6` (3í„´ = 6ê°œ ë©”ì‹œì§€)

```
ëŒ€í™” 1~6ë²ˆ (3í„´): ì „ì²´ í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬
                    â”‚
                    â”‚ 7ë²ˆì§¸ ë©”ì‹œì§€ ì¶”ê°€ ì‹œ (ìœˆë„ìš° ì´ˆê³¼)
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 1~6ë²ˆ ì¤‘ ìœˆë„ìš° ë°– ë©”ì‹œì§€   â”‚
        â”‚ ë¥¼ Geminië¡œ ìš”ì•½           â”‚
        â”‚ â†’ currentSummaryì— ì €ì¥   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
AIì— ì „ë‹¬ë˜ëŠ” ë‚´ìš©:
  [ì´ì „ ëŒ€í™” ìš”ì•½: ìš”ì•½ë³¸]
  + [ìµœê·¼ ëŒ€í™”: ìµœê·¼ 6ê°œ ë©”ì‹œì§€]
  + [í˜„ì¬ ì§ˆë¬¸]
```

### ìš”ì•½ ëª¨ë¸ ì„¤ì •
- **ëª¨ë¸**: `gemini-2.5-flash` (temperature: 0.3)
- **í”„ë¡¬í”„íŠ¸**: `res/values/string_prompt.xml` â€” `prompt_summary_system`
- **ê·œì¹™**: 200ì ì´ë‚´, í•œêµ­ì–´, ìš”ì•½ì²´

### ì €ì¥ ìœ„ì¹˜
`ChatSessionEntity.currentSummary` â€” ì„¸ì…˜ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬

---

## 4. Gemini ëª¨ë¸ êµ¬ì„±

### 3ê°œ ëª¨ë¸ ë¶„ë¦¬ ìš´ì˜

| ëª¨ë¸ | ì—­í•  | Gemini ëª¨ë¸ | temperature | topK | topP | maxTokens |
|------|------|-----------|-------------|------|------|-----------|
| queryAnalyzerModel | ì¿¼ë¦¬/ì•¡ì…˜ ë¶„ì„ | gemini-2.5-pro | 0.3 | 20 | 0.9 | 10000 |
| financialAdvisorModel | ì¬ë¬´ ìƒë‹´ ë‹µë³€ | gemini-2.5-pro | 0.7 | 40 | 0.95 | 10000 |
| summaryModel | Rolling Summary | gemini-2.5-flash | 0.3 | 20 | 0.9 | 10000 |

### í”„ë¡¬í”„íŠ¸ ìœ„ì¹˜ (XML ë¦¬ì†ŒìŠ¤)

> ëª¨ë“  ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ëŠ” `res/values/string_prompt.xml`ì—ì„œ ê´€ë¦¬

| í”„ë¡¬í”„íŠ¸ | XML key | ì‚¬ìš©ì²˜ |
|---------|---------|-------|
| ì¿¼ë¦¬ ë¶„ì„ê¸° | `prompt_query_analyzer_system` | GeminiRepository (queryAnalyzerModel) |
| ì¬ë¬´ ìƒë‹´ì‚¬ | `prompt_financial_advisor_system` | GeminiRepository (financialAdvisorModel) |
| ëŒ€í™” ìš”ì•½ | `prompt_summary_system` | GeminiRepository (summaryModel) |
| SMS ì¶”ì¶œ (ë‹¨ì¼) | `prompt_sms_extract_system` | GeminiSmsExtractor |
| SMS ì¶”ì¶œ (ë°°ì¹˜) | `prompt_sms_batch_extract_system` | GeminiSmsExtractor |
| ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ | `prompt_category_classification` | GeminiCategoryRepository |

### API í‚¤ ê´€ë¦¬
- `SettingsDataStore`ì— ì €ì¥
- ëª¨ë“  ëª¨ë¸ì´ ê°™ì€ API í‚¤ ê³µìœ 
- í‚¤ ë³€ê²½ ì‹œ ëª¨ë“  ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ ì¬ìƒì„±

---

## 5. ì±„íŒ… ë°ì´í„° êµ¬ì¡°

### ì„¸ì…˜ (ChatSessionEntity)
```
chat_sessions í…Œì´ë¸”
â”œâ”€â”€ id: Long (PK)
â”œâ”€â”€ title: String ("ìƒˆ ëŒ€í™”")
â”œâ”€â”€ currentSummary: String? (Rolling Summary)
â”œâ”€â”€ createdAt: Long
â””â”€â”€ updatedAt: Long
```

### ë©”ì‹œì§€ (ChatEntity)
```
chat_history í…Œì´ë¸”
â”œâ”€â”€ id: Long (PK)
â”œâ”€â”€ sessionId: Long (FK â†’ chat_sessions.id, CASCADE)
â”œâ”€â”€ message: String
â”œâ”€â”€ isUser: Boolean
â””â”€â”€ timestamp: Long
```

### ê´€ê³„
`ChatSession (1) â†â†’ (N) ChatEntity`
ì„¸ì…˜ ì‚­ì œ ì‹œ ì†Œì† ë©”ì‹œì§€ë„ ìë™ ì‚­ì œ (CASCADE)

---

## 6. ì±„íŒ… íë¦„ ìƒì„¸

```
ì‚¬ìš©ì ë©”ì‹œì§€ ì…ë ¥
â”‚
â”œâ”€â”€ 1. ChatEntity ì €ì¥ (isUser = true)
â”‚
â”œâ”€â”€ 2. ChatContextBuilderë¡œ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
â”‚   â”œâ”€â”€ Rolling Summary ì¡°íšŒ
â”‚   â”œâ”€â”€ ìµœê·¼ Nê°œ ë©”ì‹œì§€ ì¡°íšŒ (ASC)
â”‚   â””â”€â”€ í†µí•© í”„ë¡¬í”„íŠ¸ ìƒì„±
â”‚
â”œâ”€â”€ 3. Step 1: analyzeQueryNeeds()
â”‚   â””â”€â”€ JSON íŒŒì‹± â†’ DataQueryRequest (ì¿¼ë¦¬ + ì•¡ì…˜ + clarification)
â”‚
â”œâ”€â”€ 3-1. Clarification ë¶„ê¸° (ì§ˆë¬¸ì´ ëª¨í˜¸í•œ ê²½ìš°)
â”‚   â”œâ”€â”€ isClarification = true â†’ í™•ì¸ ì§ˆë¬¸ì„ AI ì‘ë‹µìœ¼ë¡œ ì €ì¥
â”‚   â””â”€â”€ Step 4~6 ê±´ë„ˆëœ€ â†’ ì‚¬ìš©ì ì¶”ê°€ ì…ë ¥ ëŒ€ê¸°
â”‚
â”œâ”€â”€ 4. ë°ì´í„° ì¡°íšŒ (DataQueryParser â†’ ExpenseDao ë“±)
â”‚   â””â”€â”€ QueryResult ëª©ë¡ ìƒì„±
â”‚   â””â”€â”€ ANALYTICS ì¿¼ë¦¬ ì‹œ executeAnalytics() (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
â”‚
â”œâ”€â”€ 5. ì•¡ì…˜ ì‹¤í–‰ (ìˆëŠ” ê²½ìš°)
â”‚   â””â”€â”€ ActionResult ëª©ë¡ ìƒì„±
â”‚   â””â”€â”€ StoreAliasManagerë¡œ ê°€ê²Œ ë³„ì¹­ í¬í•¨ ì¼ê´„ ì²˜ë¦¬
â”‚
â”œâ”€â”€ 6. Step 3: generateFinalAnswerWithContext()
â”‚   â””â”€â”€ [ìš”ì•½ + ìµœê·¼ ëŒ€í™” + ë°ì´í„° + ì§ˆë¬¸] â†’ Gemini
â”‚
â”œâ”€â”€ 7. AI ì‘ë‹µ ChatEntity ì €ì¥ (isUser = false)
â”‚
â””â”€â”€ 8. Rolling Summary ì—…ë°ì´íŠ¸ (í•„ìš” ì‹œ)
    â””â”€â”€ ìœˆë„ìš° ë°– ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ìš”ì•½ ê°±ì‹ 
```

### ì¶”ê°€ ê¸°ëŠ¥
- **Clarification ë£¨í”„**: ì§ˆë¬¸ì´ ëª¨í˜¸í•˜ë©´ ì¿¼ë¦¬ ìƒì„± ëŒ€ì‹  í™•ì¸ ì§ˆë¬¸ ë°˜í™˜ â†’ ì‚¬ìš©ì ì¶”ê°€ ì…ë ¥ í›„ ì¬ë¶„ì„
- **ìë™ íƒ€ì´í‹€ ìƒì„±**: ì±„íŒ…ë°© ë‚˜ê°ˆ ë•Œ ëŒ€í™” ë‚´ìš© ê¸°ë°˜ LLM íƒ€ì´í‹€ ìƒì„± (15ì ì œí•œ)
- **ì¬ì‹œë„**: AI ì‘ë‹µ ì‹¤íŒ¨ ì‹œ canRetry í”Œë˜ê·¸ë¡œ ì¬ì‹œë„ í—ˆìš©
- **Mutex**: sendMutexë¡œ ë™ì‹œ ë©”ì‹œì§€ ì „ì†¡ ë°©ì§€

---

## 7. ì§ˆë¬¸ ì˜ˆì‹œì™€ ì²˜ë¦¬ íë¦„

### ë°ì´í„° ì¡°íšŒ ì§ˆë¬¸
| ì§ˆë¬¸ | ì¿¼ë¦¬ íƒ€ì… |
|------|----------|
| "ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œì´ ì–¼ë§ˆì•¼?" | `total_expense` |
| "ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë³´ì—¬ì¤˜" | `expense_by_category` |
| "ì¿ íŒ¡ì—ì„œ ì–¼ë§ˆ ì¼ì–´?" | `expense_by_store` |
| "ìµœê·¼ 10ê±´ ì§€ì¶œ ë‚´ì—­" | `expense_list (limit: 10)` |
| "ì‹ë¹„ê°€ ìˆ˜ì… ëŒ€ë¹„ ì ì ˆí•´?" | `category_ratio` + `expense_by_category` |
| "ì£¼ë§ì— ê°€ì¥ ë§ì´ ì“´ ì¹´í…Œê³ ë¦¬ëŠ”?" | `analytics` (dayOfWeek í•„í„° + category ê·¸ë£¹í•‘) |

### ì•¡ì…˜ ìš”ì²­
| ì§ˆë¬¸ | ì•¡ì…˜ íƒ€ì… |
|------|----------|
| "ì¿ íŒ¡ì€ ì‡¼í•‘ìœ¼ë¡œ ë¶„ë¥˜í•´ì¤˜" | `update_category_by_store` |
| "ë°°ë‹¬ í¬í•¨ëœê±´ ì‹ë¹„ë¡œ ë°”ê¿”" | `update_category_by_keyword` |
| "ê´‘ê³  ë¬¸ì ì œì™¸í•´ì¤˜" | `add_sms_exclusion` |
| "ì ì‹¬ 12000ì› ì¶”ê°€í•´ì¤˜" | `add_expense` |

### ì¼ë°˜ ìƒë‹´
| ì§ˆë¬¸ | ì²˜ë¦¬ |
|------|------|
| "ì†Œë¹„ ìŠµê´€ ì–´ë•Œ?" | ë°ì´í„° ì¡°íšŒ + ë¶„ì„ ë‹µë³€ |
| "ì €ì¶• ëª©í‘œ ì„¸ì›Œì¤˜" | ìƒë‹´ ëª¨ë“œ ë‹µë³€ |

---

## 8. ê´€ë ¨ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ì—­í•  |
|------|------|
| `feature/chat/data/GeminiRepository.kt` | Gemini API í†µì‹  (3ê°œ ëª¨ë¸) |
| `feature/chat/data/ChatRepository.kt` | ì±„íŒ… ë°ì´í„° ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ |
| `feature/chat/data/ChatRepositoryImpl.kt` | ì±„íŒ… ë°ì´í„° ê´€ë¦¬ êµ¬í˜„ |
| `feature/chat/data/ChatPrompts.kt` | í”„ë¡¬í”„íŠ¸ í‚¤ ì°¸ì¡° (ì‹¤ì œ ë‚´ìš©ì€ string_prompt.xml) |
| `feature/chat/ui/ChatViewModel.kt` | ì±„íŒ… UI ìƒíƒœ + ì¿¼ë¦¬/ì•¡ì…˜/ë¶„ì„ ì‹¤í–‰ |
| `feature/chat/ui/ChatScreen.kt` | ì±„íŒ… UI (Compose) |
| `core/util/DataQueryParser.kt` | JSON â†’ ì¿¼ë¦¬/ì•¡ì…˜/clarification íŒŒì‹± + QueryType/ActionType enum |
| `core/util/StoreAliasManager.kt` | ê°€ê²Œëª… ë³„ì¹­ ê´€ë¦¬ (ì¼ê´„ ì²˜ë¦¬ ì§€ì›) |
| `core/database/dao/ChatDao.kt` | ì„¸ì…˜/ë©”ì‹œì§€ DAO |
| `core/database/entity/ChatEntity.kt` | ë©”ì‹œì§€ ì—”í‹°í‹° |
| `core/database/entity/ChatSessionEntity.kt` | ì„¸ì…˜ ì—”í‹°í‹° |
| `res/values/string_prompt.xml` | ëª¨ë“  AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (6ì¢…) |

---

## 9. ë²¡í„° ê¸°ë°˜ ê¸°ëŠ¥ í˜„í™©

| ê¸°ëŠ¥ | ì‚¬ìš© ì—¬ë¶€ | ì„¤ëª… |
|------|----------|------|
| ëŒ€í™” íˆìŠ¤í† ë¦¬ ë²¡í„° ê²€ìƒ‰ | âŒ ë¯¸ì‚¬ìš© | ëŒ€í™” ê¸°ë¡ì€ ë²¡í„°í™”í•˜ì§€ ì•ŠìŒ |
| RAG (Retrieval Augmented Generation) | âŒ ë¯¸ì‚¬ìš© | ê³¼ê±° ëŒ€í™”ì—ì„œ ê´€ë ¨ ë‚´ìš© ê²€ìƒ‰í•˜ëŠ” ê¸°ëŠ¥ ì—†ìŒ |
| Rolling Summary | âœ… ì‚¬ìš© | LLM ê¸°ë°˜ ìš”ì•½ìœ¼ë¡œ ë§¥ë½ ì••ì¶• (ë²¡í„° ë¶ˆí•„ìš”) |
| ì§€ì¶œ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸ | âœ… ì‚¬ìš© | Room DB ì§ì ‘ ì¿¼ë¦¬ (SQL, ë²¡í„° ë¶ˆí•„ìš”) |
| ANALYTICS ì¸ë©”ëª¨ë¦¬ ë¶„ì„ | âœ… ì‚¬ìš© | í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°/ê·¸ë£¹í•‘/ì§‘ê³„ |

í˜„ì¬ ì±„íŒ… ì‹œìŠ¤í…œì€ **ìˆœì°¨ì  ë§¥ë½ ê´€ë¦¬**(Rolling Summary)ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
ë²¡í„° ì„ë² ë”©ì€ SMS ë¶„ë¥˜(`SmsPatternEntity`)ì™€ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜(`StoreEmbeddingEntity`)ì—ë§Œ í™œìš©ë©ë‹ˆë‹¤.

---

*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026-02-15*
