# AI ì±„íŒ… ìƒë‹´ ì‹œìŠ¤í…œ

> Gemini ê¸°ë°˜ ì¬ë¬´ ìƒë‹´ AI: 2-Phase ì¿¼ë¦¬ ë¶„ì„ + Rolling Summary ëŒ€í™” ë§¥ë½ ê´€ë¦¬

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

MoneyTalkì˜ ì±„íŒ… ì‹œìŠ¤í…œì€ ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ì§€ì¶œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³ ,
ë°ì´í„° ê¸°ë°˜ì˜ ë§ì¶¤ ì¬ë¬´ ìƒë‹´ì„ ì œê³µí•©ë‹ˆë‹¤.

```
ì‚¬ìš©ì ì§ˆë¬¸: "ì´ë²ˆ ë‹¬ ì‹ë¹„ ì–¼ë§ˆì•¼?"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: ì¿¼ë¦¬ ë¶„ì„ (queryAnalyzerModel)     â”‚
â”‚  â”” "ì‹ë¹„ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²ˆ ë‹¬ í•©ê³„ê°€ í•„ìš”í•˜êµ°"    â”‚
â”‚  â”” JSON: {type: "expense_by_category",     â”‚
â”‚           category: "ì‹ë¹„", ...}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°ì´í„° ì¡°íšŒ (Room DB)                       â”‚
â”‚  â”” ExpenseDao.getExpenseSumByCategory()    â”‚
â”‚  â”” ê²°ê³¼: ì‹ë¹„ 350,000ì›                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: ë‹µë³€ ìƒì„± (financialAdvisorModel)  â”‚
â”‚  â”” [Rolling Summary + ìµœê·¼ ëŒ€í™” + ë°ì´í„°]    â”‚
â”‚  â”” "ì´ë²ˆ ë‹¬ ì‹ë¹„ëŠ” 35ë§Œì›ì´ì•¼! ìˆ˜ì… ëŒ€ë¹„      â”‚
â”‚     15%ë¡œ ì ì • ìˆ˜ì¤€ì´ë„¤ ğŸ‘"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. 2-Phase ì²˜ë¦¬ ì•„í‚¤í…ì²˜

### Phase 1: ì¿¼ë¦¬/ì•¡ì…˜ ë¶„ì„

**íŒŒì¼**: `feature/chat/data/GeminiRepository.kt` â€” `analyzeQueryNeeds()`
**ëª¨ë¸**: `gemini-2.5-flash` (temperature: 0.3)

ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ í•„ìš”í•œ DB ì¿¼ë¦¬ì™€ ì•¡ì…˜ì„ JSONìœ¼ë¡œ ê²°ì •í•©ë‹ˆë‹¤.

#### ì‚¬ìš© ê°€ëŠ¥í•œ ì¿¼ë¦¬ íƒ€ì…

| íƒ€ì… | ì„¤ëª… | í•„ìˆ˜ íŒŒë¼ë¯¸í„° |
|------|------|-------------|
| `total_expense` | ê¸°ê°„ ë‚´ ì´ ì§€ì¶œ | startDate, endDate |
| `total_income` | ê¸°ê°„ ë‚´ ì´ ìˆ˜ì… | startDate, endDate |
| `expense_by_category` | ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í•©ê³„ | startDate, endDate |
| `expense_list` | ì§€ì¶œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ | limit |
| `expense_by_store` | íŠ¹ì • ê°€ê²Œ ì§€ì¶œ | storeName |
| `daily_totals` | ì¼ë³„ ì§€ì¶œ í•©ê³„ | startDate, endDate |
| `monthly_totals` | ì›”ë³„ ì§€ì¶œ í•©ê³„ | â€” |
| `monthly_income` | ì„¤ì •ëœ ì›” ìˆ˜ì… | â€” |
| `uncategorized_list` | ë¯¸ë¶„ë¥˜ í•­ëª© | â€” |
| `category_ratio` | ìˆ˜ì… ëŒ€ë¹„ ë¹„ìœ¨ ë¶„ì„ | â€” |

#### ì‚¬ìš© ê°€ëŠ¥í•œ ì•¡ì…˜ íƒ€ì…

| íƒ€ì… | ì„¤ëª… | í•„ìˆ˜ íŒŒë¼ë¯¸í„° |
|------|------|-------------|
| `update_category` | íŠ¹ì • ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ë³€ê²½ | expenseId, newCategory |
| `update_category_by_store` | ê°€ê²Œëª… ê¸°ì¤€ ì¼ê´„ ë³€ê²½ | storeName, newCategory |
| `update_category_by_keyword` | í‚¤ì›Œë“œ í¬í•¨ ì¼ê´„ ë³€ê²½ | searchKeyword, newCategory |

#### ë‚ ì§œ í•´ì„ ê·œì¹™
- "ì´ë²ˆë‹¬" â†’ ì´ë²ˆë‹¬ 1ì¼ ~ ì˜¤ëŠ˜
- "ì§€ë‚œë‹¬" â†’ ì „ì›” 1ì¼ ~ ë§ì¼
- "3ê°œì›”ê°„" â†’ ìµœê·¼ 3ê°œì›”
- ì—°ë„ ë¯¸ì§€ì • â†’ ì˜¬í•´ë¡œ ê°€ì •

### Phase 2: ë‹µë³€ ìƒì„±

**ëª¨ë¸**: `gemini-2.5-flash` (temperature: 0.7)

System Instructionì— ì¬ë¬´ ìƒë‹´ì‚¬ ì—­í• ì´ ì •ì˜ë˜ì–´ ìˆìœ¼ë©°, ë‹¤ìŒ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤:

- ì›” ìˆ˜ì… ì •ë³´
- Phase 1ì—ì„œ ì¡°íšŒí•œ ë°ì´í„°
- ì•¡ì…˜ ì‹¤í–‰ ê²°ê³¼
- Rolling Summary (ê³¼ê±° ëŒ€í™” ë§¥ë½)
- ìµœê·¼ ëŒ€í™” ë©”ì‹œì§€

#### ë‹µë³€ ìŠ¤íƒ€ì¼
- í•œêµ­ì–´ ë°˜ë§
- ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
- êµ¬ì²´ì  ìˆ«ìì™€ ì‹¤ìš©ì  ì¡°ì–¸
- ê°„ê²°í•˜ê³  ì‘ì›í•˜ëŠ” í†¤

#### ì§€ì¶œ ì ì • ê¸°ì¤€
| ì¹´í…Œê³ ë¦¬ | ìˆ˜ì… ëŒ€ë¹„ ì ì • ë¹„ìœ¨ |
|---------|-----------------|
| ì‹ë¹„ | 15-20% |
| ì£¼ê±°ë¹„ | 25-30% |
| êµí†µë¹„ | 5-10% |
| ì¹´í˜/ì—¬ê°€ | 5-10% |
| ì €ì¶• | 20% ì´ìƒ ê¶Œì¥ |
| ì´ ì§€ì¶œ | 80% ì´í•˜ë©´ ê±´ê°• |

---

## 3. Rolling Summary (ëŒ€í™” ë§¥ë½ ê´€ë¦¬)

### ë¬¸ì œ
AI ëª¨ë¸ì€ ì»¨í…ìŠ¤íŠ¸ ì œí•œì´ ìˆì–´ ê¸´ ëŒ€í™”ë¥¼ ëª¨ë‘ ì „ë‹¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ "ì•„ê¹Œ ë¬¼ì–´ë³¸ ì‹ë¹„ ë§ì¸ë°..." ê°™ì€ ë§¥ë½ ì°¸ì¡°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

### í•´ê²°: Rolling Summary ì „ëµ

```
ëŒ€í™” 1~10ë²ˆ: ì „ì²´ í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬
                    â”‚
                    â”‚ 11ë²ˆì§¸ ë©”ì‹œì§€ ì¶”ê°€ ì‹œ
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 1~4ë²ˆ ë©”ì‹œì§€ë¥¼ ìš”ì•½        â”‚
        â”‚ (Gemini summaryModel)    â”‚
        â”‚ â†’ currentSummaryì— ì €ì¥   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
AIì— ì „ë‹¬ë˜ëŠ” ë‚´ìš©:
  [ìš”ì•½: 1~4ë²ˆ ëŒ€í™” ìš”ì•½ë³¸]
  + [ì „ì²´: 5~11ë²ˆ ë©”ì‹œì§€]
```

### ìš”ì•½ ëª¨ë¸ ì„¤ì •
- **ëª¨ë¸**: `gemini-2.5-flash` (temperature: 0.3)
- **ìµœëŒ€ ì¶œë ¥**: 512 í† í°
- **ê·œì¹™**: 200ì ì´ë‚´, í•œêµ­ì–´, ìš”ì•½ì²´

### ëˆ„ì  ìš”ì•½ ì—…ë°ì´íŠ¸
```
ê¸°ì¡´ ìš”ì•½ + ìƒˆë¡œ ë°€ë ¤ë‚œ ë©”ì‹œì§€ â†’ Gemini â†’ í†µí•© ìš”ì•½ë³¸
```

### ì €ì¥ ìœ„ì¹˜
`ChatSessionEntity.currentSummary` â€” ì„¸ì…˜ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬

---

## 4. Gemini ëª¨ë¸ êµ¬ì„±

### 3ê°œ ëª¨ë¸ ë¶„ë¦¬ ìš´ì˜

| ëª¨ë¸ | ì—­í•  | temperature | maxTokens |
|------|------|-------------|-----------|
| `queryAnalyzerModel` | ì¿¼ë¦¬/ì•¡ì…˜ ë¶„ì„ | 0.3 | 512 |
| `financialAdvisorModel` | ì¬ë¬´ ìƒë‹´ ë‹µë³€ | 0.7 | 1024 |
| `summaryModel` | Rolling Summary ìƒì„± | 0.3 | 512 |

ëª¨ë‘ `gemini-2.5-flash` ì‚¬ìš©, ê°ê¸° ë‹¤ë¥¸ System Instruction ì ìš©

### API í‚¤ ê´€ë¦¬
- `SettingsDataStore`ì— ì•”í˜¸í™” ì €ì¥
- ëª¨ë“  ëª¨ë¸ì´ ê°™ì€ API í‚¤ ê³µìœ 
- í‚¤ ë³€ê²½ ì‹œ ëª¨ë“  ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ ì¬ìƒì„±

---

## 5. ì±„íŒ… ë°ì´í„° êµ¬ì¡°

### ì„¸ì…˜ (ChatSessionEntity)
```
chat_sessions í…Œì´ë¸”
â”œâ”€â”€ id: Long (PK)
â”œâ”€â”€ title: String ("ìƒˆ ëŒ€í™”")
â”œâ”€â”€ currentSummary: String? (Rolling Summary)
â”œâ”€â”€ createdAt: Long
â””â”€â”€ updatedAt: Long
```

### ë©”ì‹œì§€ (ChatEntity)
```
chat_history í…Œì´ë¸”
â”œâ”€â”€ id: Long (PK)
â”œâ”€â”€ sessionId: Long (FK â†’ chat_sessions.id, CASCADE)
â”œâ”€â”€ message: String
â”œâ”€â”€ isUser: Boolean
â””â”€â”€ timestamp: Long
```

### ê´€ê³„
`ChatSession (1) â†â†’ (N) ChatEntity`
ì„¸ì…˜ ì‚­ì œ ì‹œ ì†Œì† ë©”ì‹œì§€ë„ ìë™ ì‚­ì œ (CASCADE)

---

## 6. ì±„íŒ… íë¦„ ìƒì„¸

```
ì‚¬ìš©ì ë©”ì‹œì§€ ì…ë ¥
â”‚
â”œâ”€â”€ 1. ChatEntity ì €ì¥ (isUser = true)
â”‚
â”œâ”€â”€ 2. ChatContextBuilderë¡œ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
â”‚   â”œâ”€â”€ Rolling Summary ì¡°íšŒ
â”‚   â”œâ”€â”€ ìµœê·¼ Nê°œ ë©”ì‹œì§€ ì¡°íšŒ (ASC)
â”‚   â””â”€â”€ í†µí•© í”„ë¡¬í”„íŠ¸ ìƒì„±
â”‚
â”œâ”€â”€ 3. Phase 1: analyzeQueryNeeds()
â”‚   â””â”€â”€ JSON íŒŒì‹± â†’ DataQueryRequest
â”‚
â”œâ”€â”€ 4. ë°ì´í„° ì¡°íšŒ (DataQueryParser â†’ ExpenseDao ë“±)
â”‚   â””â”€â”€ QueryResult ëª©ë¡ ìƒì„±
â”‚
â”œâ”€â”€ 5. ì•¡ì…˜ ì‹¤í–‰ (ìˆëŠ” ê²½ìš°)
â”‚   â””â”€â”€ ActionResult ëª©ë¡ ìƒì„±
â”‚
â”œâ”€â”€ 6. Phase 2: generateFinalAnswerWithContext()
â”‚   â””â”€â”€ [ìš”ì•½ + ìµœê·¼ ëŒ€í™” + ë°ì´í„° + ì§ˆë¬¸] â†’ Gemini
â”‚
â”œâ”€â”€ 7. AI ì‘ë‹µ ChatEntity ì €ì¥ (isUser = false)
â”‚
â””â”€â”€ 8. Rolling Summary ì—…ë°ì´íŠ¸ (í•„ìš” ì‹œ)
    â””â”€â”€ ìœˆë„ìš° ë°– ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ìš”ì•½ ê°±ì‹ 
```

---

## 7. ì§ˆë¬¸ ì˜ˆì‹œì™€ ì²˜ë¦¬ íë¦„

### ë°ì´í„° ì¡°íšŒ ì§ˆë¬¸
| ì§ˆë¬¸ | ì¿¼ë¦¬ íƒ€ì… |
|------|----------|
| "ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œì´ ì–¼ë§ˆì•¼?" | `total_expense` |
| "ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë³´ì—¬ì¤˜" | `expense_by_category` |
| "ì¿ íŒ¡ì—ì„œ ì–¼ë§ˆ ì¼ì–´?" | `expense_by_store` |
| "ìµœê·¼ 10ê±´ ì§€ì¶œ ë‚´ì—­" | `expense_list (limit: 10)` |
| "ì‹ë¹„ê°€ ìˆ˜ì… ëŒ€ë¹„ ì ì ˆí•´?" | `category_ratio` + `expense_by_category` |

### ì•¡ì…˜ ìš”ì²­
| ì§ˆë¬¸ | ì•¡ì…˜ íƒ€ì… |
|------|----------|
| "ì¿ íŒ¡ì€ ì‡¼í•‘ìœ¼ë¡œ ë¶„ë¥˜í•´ì¤˜" | `update_category_by_store` |
| "ë°°ë‹¬ í¬í•¨ëœê±´ ì‹ë¹„ë¡œ ë°”ê¿”" | `update_category_by_keyword` |

### ì¼ë°˜ ìƒë‹´
| ì§ˆë¬¸ | ì²˜ë¦¬ |
|------|------|
| "ì†Œë¹„ ìŠµê´€ ì–´ë•Œ?" | ë°ì´í„° ì¡°íšŒ + ë¶„ì„ ë‹µë³€ |
| "ì €ì¶• ëª©í‘œ ì„¸ì›Œì¤˜" | ìƒë‹´ ëª¨ë“œ ë‹µë³€ |

---

## 8. ê´€ë ¨ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ì—­í•  |
|------|------|
| `feature/chat/data/GeminiRepository.kt` | Gemini API í†µì‹  (3ê°œ ëª¨ë¸) |
| `feature/chat/data/ChatRepository.kt` | ì±„íŒ… ë°ì´í„° ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ |
| `feature/chat/data/ChatRepositoryImpl.kt` | ì±„íŒ… ë°ì´í„° ê´€ë¦¬ êµ¬í˜„ |
| `feature/chat/data/ChatContextBuilder.kt` | Rolling Summary + ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± |
| `feature/chat/ui/ChatViewModel.kt` | ì±„íŒ… UI ìƒíƒœ ê´€ë¦¬ |
| `feature/chat/ui/ChatScreen.kt` | ì±„íŒ… UI (Compose) |
| `core/util/DataQueryParser.kt` | JSON â†’ ì¿¼ë¦¬ ìš”ì²­ íŒŒì‹± |
| `core/database/dao/ChatDao.kt` | ì„¸ì…˜/ë©”ì‹œì§€ DAO |
| `core/database/entity/ChatEntity.kt` | ë©”ì‹œì§€ ì—”í‹°í‹° |
| `core/database/entity/ChatSessionEntity.kt` | ì„¸ì…˜ ì—”í‹°í‹° |

---

*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026-02-07*
