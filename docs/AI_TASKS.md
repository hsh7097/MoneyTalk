# AI_TASKS.md - 작업 목록 및 완료 기준

> 작업 진행 상황 추적 문서
> **최종 갱신**: 2026-02-18

---

## Phase 0: 컨텍스트 패키징 ✅ 완료

- [x] 기존 문서 5종 읽기
- [x] docs/AI_CONTEXT.md, AI_HANDOFF.md, AI_TASKS.md, CLAUDE.md 생성

---

## Phase 1: VectorSearchEngine 책임 분리 ✅ 완료 (2026-02-08)

- [x] VectorSearchEngine 임계값 상수 5개 제거 → 순수 벡터 엔진
- [x] core/similarity/ 패키지 신설 (5개 파일)
- [x] 모든 호출자에서 SimilarityPolicy 참조로 치환
- [x] confidence < 0.6 전파 차단 정책 추가
- [x] 빌드 성공 확인

---

## 채팅 시스템 확장 ✅ 완료 (2026-02-08~09)

- [x] 채팅 액션 5개 추가 (delete_by_keyword, add_expense, update_memo, update_store_name, update_amount)
- [x] SMS 제외 채팅 액션 2개 추가 (add_sms_exclusion, remove_sms_exclusion)
- [x] ANALYTICS 쿼리 타입 추가 (클라이언트 사이드 필터/그룹핑/집계)
- [x] FINANCIAL_ADVISOR 할루시네이션 방지 규칙 추가
- [x] 프롬프트 XML 이전 (ChatPrompts.kt → string_prompt.xml)

---

## 데이터 관리 기능 ✅ 완료 (2026-02-09)

- [x] OwnedCard 시스템 (카드 화이트리스트 + CardNameNormalizer + DB v2→v3)
- [x] SMS 제외 키워드 시스템 (블랙리스트 + DB v3→v4)
- [x] DB 성능 인덱스 추가 (expenses/incomes + DB v4→v5)
- [x] 전역 스낵바 버스 도입
- [x] API 키 설정 후 저신뢰도 항목 자동 재분류
- [x] SMS 동기화/카테고리 분류 다이얼로그 진행률 표시 개선

---

## UI 공통화 ✅ 완료 (2026-02-11)

- [x] TransactionCardCompose/Info (지출/수입 통합 카드)
- [x] TransactionGroupHeaderCompose/Info (날짜별/가게별/금액별 그룹 헤더)
- [x] SegmentedTabRowCompose/Info (라운드 버튼 탭)
- [x] HistoryScreen Intent 패턴 적용 (HistoryIntent sealed interface)
- [x] Preview 파일 debug/ 소스셋 배치
- [x] 카테고리 아이콘: 벡터 아이콘 교체 시도 → revert, 이모지 유지

---

## Phase 2: SMS 분류 정확도/효율 개선 ✅ 완료 (2026-02-14)

> Phase 1 리팩토링 기반 위에서 SMS 분류 정확도/효율을 개선하는 작업들

### 2-A. 부트스트랩 모드 게이트 제거 ✅
- [x] `isBootstrap` 로직은 이미 코드에서 제거 완료 확인
- [x] 미사용 `BOOTSTRAP_THRESHOLD` 상수 제거 (HybridSmsClassifier.kt)
- [x] `hasPotentialPaymentIndicators()` 이미 존재 확인
- [x] 빌드 성공 확인

### 2-B. 캐시 재사용 임계값 조정 ✅ (현행 유지)
- [x] `SmsPatternSimilarityPolicy.profile.autoApply` 0.95 유지
- [x] `NON_PAYMENT_CACHE_THRESHOLD` 0.97 유지 결정
  - 근거: 0.95로 낮추면 payment autoApply와 동일해져 오분류 리스크 증가
- [x] 변경 불필요 판단

### 2-C. 벡터 학습 실패 시 사용자 알림 ✅
- [x] `HomeViewModel.syncSmsMessages()`에서 학습 실패 시 스낵바 알림 추가
- [x] `AppSnackbarBus.show("벡터 패턴 학습 일부 실패 (다음 동기화 시 재시도)")`
- [x] 기존 `Log.e` 로깅 유지 + UI 알림 추가

### 2-D. 채팅에서 카테고리 설정 시 자동 추가 ✅
- [x] ChatViewModel에 CategoryReferenceProvider 생성자 주입
- [x] UPDATE_CATEGORY / UPDATE_CATEGORY_BY_STORE / UPDATE_CATEGORY_BY_KEYWORD 성공 시 `invalidateCache()` 호출
- [x] 빌드 성공 확인

---

## 홈 화면 카테고리 통계 개선 🔲 대기

> 현재 홈 첫 페이지의 "지출 TOP 3" 프로그레스바를 도넛 차트 + 리스트 하이브리드 형태로 개선.
> 전체 카테고리 지출 분포를 시각적으로 한눈에 파악할 수 있도록 변경.
> 참고: 편한가계부 통계 화면의 원형 차트 스타일

### 1. 도넛 차트 컴포넌트 🔲
- [ ] Compose Canvas 기반 도넛 차트 구현 (외부 라이브러리 없이)
- [ ] 카테고리별 색상 매핑 (Category enum 기반)
- [ ] 차트 가운데에 총 지출액 표시
- [ ] 카테고리 이모지 + 비율 라벨 차트 주변에 표시
- [ ] 애니메이션: 0° → 360° 그리기 (animateFloatAsState)

### 2. 기존 TOP 3 리스트 유지 + 통합 🔲
- [ ] 도넛 차트 하단에 기존 프로그레스바 리스트 유지
- [ ] TOP 3 → 전체 카테고리 리스트로 확장 (접기/펼치기 또는 "전체보기" 버튼)
- [ ] 도넛 차트 색상과 리스트 프로그레스바 색상 동기화
- [ ] 리스트 항목 클릭 시 해당 카테고리 상세 페이지로 이동 (아래 4번 참조)

### 3. 데이터 가드 🔲
- [ ] 카테고리 3개 미만일 때 도넛 차트 대신 기존 프로그레스바 유지
- [ ] 데이터 없을 때 Empty State 표시 (빈 차트 노출 방지)
- [ ] "미분류" 카테고리 표시 정책 결정 (포함/제외/별도 표시)

### 4. 카테고리 상세 페이지 (신규 화면) 🔲
- [ ] 도넛 차트 또는 리스트에서 카테고리 클릭 시 전용 상세 페이지로 이동
- [ ] 상단: 카테고리 이모지 + 이름 + 월 네비게이션 (< 2026년 2월 >)
- [ ] 월총액 표시
- [ ] 월별 사용량 변화 라인 차트 (Compose Canvas, 최근 6~8개월 추이)
  - X축: 월 (7월, 8월, ..., 2월)
  - Y축: 금액 (자동 스케일)
  - 데이터 포인트에 원형 마커 표시
- [ ] 하단: 해당 카테고리 + 해당 월 거래 내역 리스트 (기존 TransactionCardCompose 재사용)
- [ ] 좌우 스와이프로 월 이동 (HorizontalPager 또는 스와이프 제스처)
  - 오른쪽 스와이프 → 이전 월
  - 왼쪽 스와이프 → 다음 월
  - 상단 월 표시 자동 갱신
- [ ] 참고: 편한가계부의 카테고리별 상세 페이지 (라인 차트 + 거래 리스트)

### 완료 기준
- [ ] 홈 첫 페이지에서 도넛 차트로 전체 카테고리 비율 한눈에 파악 가능
- [ ] 기존 TOP 3 리스트 정보(카테고리, 퍼센트, 금액)가 유지됨
- [ ] 차트 애니메이션이 자연스러움
- [ ] 데이터 부족 시 깨지지 않음
- [ ] 카테고리 클릭 → 상세 페이지에서 월별 추이 라인 차트 + 거래 리스트 확인 가능
- [ ] 좌우 스와이프로 월 이동이 자연스러움
- [ ] 빌드 성공 확인

---

## 카테고리별 예산 관리 🔲 대기

> 카테고리별 월 예산을 설정하고, 사용 현황을 한눈에 파악할 수 있는 기능.
> 홈 화면, 카테고리 상세 페이지, AI 채팅에서 예산 정보를 통합 노출.
> 참고: 편한가계부의 "예산추가" 화면 (카테고리 선택 + 금액 입력)

### 1. 예산 데이터 모델 (Room DB) 🔲
- [ ] `BudgetEntity` 생성 (categoryName, monthlyAmount, yearMonth)
- [ ] `BudgetDao` CRUD 쿼리 (upsert, delete, getByMonth, getByCategory)
- [ ] Room DB 마이그레이션 (v5 → v6)
- [ ] `BudgetRepository` 인터페이스 + 구현체

### 2. 예산 설정 UI 🔲
- [ ] 예산 설정 진입점: 설정(Settings) 또는 홈 화면 예산 카드에서 "설정" 버튼
- [ ] 카테고리 선택 그리드 (기존 Category enum 18개 기반, 이모지 + 이름)
- [ ] 금액 입력 (숫자 키패드, 천 단위 콤마 포매팅)
- [ ] 저장/삭제 기능
- [ ] 전체 카테고리 예산 목록 화면 (설정된 예산 리스트 + 미설정 카테고리 표시)

### 3. 홈 화면 예산 연동 🔲
- [ ] 도넛 차트 또는 카테고리 리스트에서 예산 대비 사용률 표시
  - 예: "🍔 식비 120,000 / 200,000 (60%)" — 프로그레스바로 시각화
- [ ] 예산 초과 카테고리 강조 (빨간색 경고 또는 아이콘)
- [ ] 전체 예산 요약 카드 (총 예산 대비 총 사용액)
- [ ] 예산 미설정 시 설정 유도 메시지 ("예산을 설정하면 지출 관리가 더 쉬워져요")

### 4. 카테고리 상세 페이지 연동 🔲
- [ ] 상단에 예산 게이지 바 (사용액 / 예산액, 퍼센트 표시)
- [ ] 라인 차트에 예산 기준선 점선 표시 → 월별 예산 초과/미달 한눈에 파악
- [ ] "이번 달 남은 예산: ₩80,000" 또는 "₩20,000 초과" 요약 텍스트
- [ ] 예산 미설정 카테고리는 게이지 바 대신 "예산 설정하기" 버튼 표시

### 5. AI 채팅 연동 🔲
- [ ] 예산 관련 쿼리 지원 (BUDGET 쿼리 타입 또는 기존 ANALYTICS 확장)
  - "이번 달 식비 예산 얼마나 남았어?"
  - "예산 초과한 카테고리 알려줘"
  - "전체 예산 대비 사용 현황은?"
- [ ] 예산 설정/변경 액션 지원
  - "식비 예산 30만원으로 설정해줘"
  - "교통/차량 예산 삭제해줘"
- [ ] 예산 초과 시 AI가 절약 팁/패턴 분석 제공

### 6. 예산 알림 (선택적) 🔲
- [ ] 예산 80% 도달 시 앱 내 알림 (스낵바 또는 배너)
- [ ] 예산 100% 초과 시 강조 알림
- [ ] 알림 ON/OFF 설정 (Settings)

### 완료 기준
- [ ] 카테고리별 월 예산 설정/수정/삭제 가능
- [ ] 홈 화면에서 예산 대비 사용률 한눈에 파악 가능
- [ ] 카테고리 상세 페이지에서 예산 게이지 + 라인 차트 기준선 표시
- [ ] AI 채팅으로 예산 조회/설정 가능
- [ ] 예산 미설정 상태에서도 기존 기능 정상 동작
- [ ] Room DB 마이그레이션 안전하게 처리
- [ ] 빌드 성공 확인

---

## 온보딩 & 첫 경험 개선 🔲 대기

> 앱 첫 실행 시 사용자에게 앱의 가치를 인지시키고, 필수 권한을 자연스럽게 획득하는 플로우.
> 참고: "편한가계부", "AI 가계부" 등 경쟁 앱의 온보딩 UX 벤치마크

### 1. 온보딩 인트로 화면 🔲
- [ ] 2~3페이지 스와이프형 인트로 (HorizontalPager)
- [ ] 각 페이지에서 앱의 핵심 가치 전달
  - 예: "SMS 자동 분석" / "AI 재무 코치" / "프라이버시 보호"
- [ ] 마지막 페이지에 "시작하기" CTA 버튼
- [ ] 최초 1회만 표시 (DataStore에 `onboardingCompleted` 플래그 저장)
- [ ] Lottie 또는 일러스트 애니메이션 활용

### 2. 권한 허용 화면 🔲
- [ ] 온보딩 완료 후 권한 요청 화면 진입
- [ ] SMS 권한이 왜 필요한지 사용자 친화적으로 설명
  - "카드 결제 문자를 읽어서 지출을 자동으로 기록합니다"
  - "문자 내용은 기기 내에서만 처리되며 외부로 전송되지 않습니다"
- [ ] 동의/거부 선택지 제공 (거부 시에도 수동 입력 모드로 진행 가능)
- [ ] Android 런타임 퍼미션 다이얼로그와 연계

### 3. 스플래시 화면 개선 🔲
- [ ] 현재 스플래시 → 온보딩 → 권한 → 홈 순서로 플로우 재설계
- [ ] 스플래시에서 앱 로고/브랜딩 표시 (현재 Lottie 활용 중)
- [ ] 최초 실행 여부에 따라 분기: 신규 → 온보딩, 기존 → 홈

### 4. 첫 실행 코치마크 (말풍선 가이드) 🔲
- [ ] 온보딩 완료 후 홈 화면에서 핵심 기능 안내 코치마크 표시
  - 예: "SMS 동기화 버튼" 가리키며 "여기를 눌러 카드 문자를 가져오세요"
  - 예: 하단 탭의 "AI 상담" 가리키며 "AI에게 소비 습관을 물어보세요"
- [ ] 순차적으로 2~3개 코치마크 표시 후 자동 종료
- [ ] 최초 1회만 표시 (DataStore 플래그)
- [ ] 참고: 편한가계부의 "카드문자 자동저장" 코치마크 스타일

### 5. 빈 화면(Empty State) 가이드 🔲
- [ ] 데이터 없는 홈 화면에서 행동 유도 메시지
  - 예: "아직 지출 내역이 없습니다. SMS 동기화로 자동 입력해보세요" + CTA 버튼
- [ ] 데이터 없는 내역 화면에서도 동일하게 안내
- [ ] 데이터 없는 채팅 화면에서도 대화 예시 제안
- [ ] 참고: 편한가계부의 "데이터가 없습니다" + 아이콘 스타일

### 6. SMS 최초 동기화 제안 🔲
- [ ] 권한 허용 후 홈 진입 시 "최근 N일간의 카드 문자를 가져올까요?" 다이얼로그
- [ ] 기간 선택 옵션 (30일/60일/90일 또는 사용자 입력)
- [ ] 가져오기 완료 후 결과 요약 ("N건의 지출이 등록되었습니다")
- [ ] 새 카드 감지 시 자동 등록 안내 (편한가계부의 "[KB] 새롭게 확인되었습니다" 참고)

### 완료 기준
- [ ] 첫 설치 사용자가 앱의 핵심 가치를 인지한 상태로 홈 화면 진입
- [ ] SMS 권한을 자연스럽게 획득 (강제 느낌 없이)
- [ ] 권한 거부 시에도 앱 사용 가능 (수동 입력 모드)
- [ ] 기존 사용자는 온보딩 스킵 → 바로 홈 진입
- [ ] 빈 화면에서 다음 행동을 명확히 안내
- [ ] 첫 SMS 동기화까지 자연스럽게 유도
- [ ] 빌드 성공 확인

---

## 앱 알림(Notification) 기반 결제 트래킹 🔲 대기

> SMS가 아닌 앱 푸시 알림으로 오는 결제 내역을 캡처하여 지출을 자동 기록.
> 카카오페이, 토스, 네이버페이, 카드사 앱 등 간편결제 앱의 결제 알림 대응.
> 참고: 편한가계부의 "금융 어플 알림 설정" 기능

### 1. NotificationListenerService 구현 🔲
- [ ] `NotificationListenerService` 상속 서비스 구현
- [ ] `onNotificationPosted()` 에서 알림 텍스트(title, text, bigText) 추출
- [ ] AndroidManifest에 서비스 등록 + `BIND_NOTIFICATION_LISTENER_SERVICE` 권한
- [ ] 서비스 활성화 여부 체크 유틸 (`Settings.Secure.ENABLED_NOTIFICATION_LISTENERS`)

### 2. 금융 앱 필터링 🔲
- [ ] 대상 앱 패키지명 화이트리스트 관리
  - 카카오페이: `com.kakaopay.app`
  - 토스: `viva.republica.toss`
  - 네이버페이: `com.naverfin.payapp`
  - 신한SOL: `com.shinhan.sbanking`
  - KB스타뱅킹: `com.kbstar.kbbank`
  - 등 주요 금융 앱
- [ ] Settings에서 사용자가 앱별 ON/OFF 설정 가능
- [ ] 새 금융 앱 감지 시 등록 제안 (편한가계부 스타일)

### 3. 알림 텍스트 파싱 🔲
- [ ] 기존 SmsParser 파싱 로직 재사용 (금액, 가게명, 카드명 추출)
- [ ] 앱별 알림 포맷 대응 (카카오페이/토스/네이버페이 각각 형식 다름)
- [ ] 파싱 실패 시 Gemini LLM 폴백 (기존 3-tier 파이프라인 활용)

### 4. 온보딩/권한 연동 🔲
- [ ] 권한 허용 화면에서 "알림 액세스" 권한도 함께 안내
  - "앱 결제 알림을 읽어 카카오페이, 토스 등의 결제도 자동으로 기록합니다"
- [ ] 알림 액세스 허용은 시스템 설정 화면으로 이동 (런타임 퍼미션 아님)
- [ ] 거부 시에도 SMS 모드로 정상 동작

### 완료 기준
- [ ] 카카오페이/토스/네이버페이 결제 알림 → 지출 자동 등록
- [ ] 기존 SMS 파싱과 중복 등록 방지 (동일 결제 판별)
- [ ] 사용자가 앱별 알림 트래킹 ON/OFF 제어 가능
- [ ] 알림 액세스 권한 거부 시에도 앱 정상 동작 (SMS만 사용)
- [ ] 빌드 성공 확인
